# RBAC æ¬Šé™è¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

ç•¶æ‚¨é‡åˆ°ã€Œæ˜æ˜æœ‰æ¬Šé™å»è¢«é˜»æ“‹ã€çš„å•é¡Œæ™‚ï¼Œè«‹æŒ‰ç…§æœ¬æŒ‡å—é€²è¡Œè¨ºæ–·å’Œä¿®å¾©ã€‚

---

## ğŸ” å¿«é€Ÿè¨ºæ–·

### æ­¥é©Ÿ 1ï¼šç¢ºèªæ‚¨çš„è§’è‰²å’Œæ¬Šé™

1. **ç™»å…¥ Management Center**
2. **é€²å…¥ã€Œæ¬Šé™ç®¡ç†ã€é é¢**
3. **æŸ¥çœ‹æ‚¨çš„è§’è‰²æ“æœ‰å“ªäº›æ¬Šé™**

å¦‚æœæ‚¨çœ‹åˆ°ä»¥ä¸‹è¨Šæ¯ï¼Œè¡¨ç¤ºæ‚¨æ²’æœ‰æ¬Šé™ç®¡ç†æ¬Šé™ï¼Œéœ€è¦è¯çµ¡ç®¡ç†å“¡ï¼š
```
ç„¡ç®¡ç†æ¬Šé™
éœ€è¦ä»¥ä¸‹æ¬Šé™ï¼šrbac.manage
```

### æ­¥é©Ÿ 2ï¼šé‹è¡Œç”¨æˆ¶æ¬Šé™è¨ºæ–·å·¥å…·

å¦‚æœæ‚¨æœ‰æ•¸æ“šåº«è¨ªå•æ¬Šé™ï¼Œå¯ä»¥é‹è¡Œä»¥ä¸‹ SQL è…³æœ¬ä¾†è¨ºæ–·å•é¡Œï¼š

**æ–‡ä»¶ä½ç½®ï¼š** `supabase/migrations/diagnose_user_permissions.sql`

**ä½¿ç”¨æ–¹æ³•ï¼š**
1. æ‰“é–‹æ–‡ä»¶
2. å°‡ `{USER_EMAIL}` æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› email åœ°å€
3. åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œ

**è¨ºæ–·è¼¸å‡ºå°‡é¡¯ç¤ºï¼š**
- âœ… æ‚¨çš„å“¡å·¥è¨˜éŒ„å’Œè§’è‰²
- âœ… æ‚¨è¢«åˆ†é…çš„ RBAC è§’è‰²
- âœ… æ‚¨æ“æœ‰çš„æ‰€æœ‰æ¬Šé™
- âœ… é—œéµåŠŸèƒ½çš„æ¬Šé™æª¢æŸ¥çµæœ
- âš ï¸ å•é¡Œè¨ºæ–·å’Œä¿®å¾©å»ºè­°

### æ­¥é©Ÿ 3ï¼šç†è§£å•é¡ŒåŸå› 

æ ¹æ“šè¨ºæ–·çµæœï¼Œå¸¸è¦‹å•é¡ŒåŒ…æ‹¬ï¼š

| è¨ºæ–·çµæœ | å•é¡ŒåŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|---------|---------|---------|
| âŒ æ‰¾ä¸åˆ°å“¡å·¥è¨˜éŒ„ | ç”¨æˆ¶å¸³è™Ÿæ²’æœ‰é—œè¯åˆ° employees è¡¨ | å‰µå»ºå“¡å·¥è¨˜éŒ„ |
| âŒ æ²’æœ‰ RBAC è§’è‰²åˆ†é… | è§’è‰²åŒæ­¥å¤±æ•— | åŸ·è¡Œè§’è‰²åŒæ­¥ä¿®å¾© |
| âŒ è§’è‰²ç„¡æ³•æ˜ å°„ | `employees.role` å€¼ä¸æ­£ç¢º | ä¿®æ­£å“¡å·¥è§’è‰² |
| âš ï¸ ç„¡è»Šè¼›ç®¡ç†æ¬Šé™ | æ¬Šé™åªåˆ†é…çµ¦ manager/admin | èª¿æ•´æ¬Šé™åˆ†é… |

---

## ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šåŸ·è¡Œè§’è‰²åŒæ­¥ä¿®å¾©ï¼ˆæ¨è–¦å…ˆåŸ·è¡Œï¼‰

**é©ç”¨æƒ…æ³ï¼š**
- è¨ºæ–·é¡¯ç¤ºã€Œæ²’æœ‰ RBAC è§’è‰²åˆ†é…ã€
- è¨ºæ–·é¡¯ç¤ºã€Œè§’è‰²åŒæ­¥å¤±æ•—ã€

**æ“ä½œæ­¥é©Ÿï¼š**

1. **é‹è¡Œä¿®å¾©é·ç§»ï¼š**
   ```
   æ–‡ä»¶ï¼šsupabase/migrations/fix_role_sync_add_missing_roles.sql
   ```

2. **é·ç§»å°‡æœƒï¼š**
   - âœ… æ›´æ–° `sync_employee_role_to_rbac()` è§¸ç™¼å™¨å‡½æ•¸
   - âœ… æ·»åŠ  'staff' å’Œ 'manager' è§’è‰²æ˜ å°„
   - âœ… é‡æ–°åŒæ­¥æ‰€æœ‰ç¾æœ‰å“¡å·¥
   - âœ… é¡¯ç¤ºåŒæ­¥çµæœ

3. **é æœŸè¼¸å‡ºï¼š**
   ```
   ========================================
   è§’è‰²åŒæ­¥å®Œæˆï¼š
     âœ… æˆåŠŸåŒæ­¥ï¼š15 ä½å“¡å·¥
     âŒ å¤±æ•—ï¼š0 ä½å“¡å·¥
   ========================================
   ```

### æ–¹æ¡ˆ Bï¼šé€šé Management Center èª¿æ•´æ¬Šé™

**é©ç”¨æƒ…æ³ï¼š**
- æ‚¨æœ‰ RBAC è§’è‰²ï¼Œä½†ç¼ºå°‘ç‰¹å®šåŠŸèƒ½æ¬Šé™
- ä¾‹å¦‚ï¼šstaff è§’è‰²ç„¡æ³•æ–°å¢/ç·¨è¼¯è»Šè¼›

**æ“ä½œæ­¥é©Ÿï¼š**

1. **ç™»å…¥ Management Center**
2. **é€²å…¥ã€Œæ¬Šé™ç®¡ç†ã€â†’ã€Œè§’è‰²ç®¡ç†ã€**
3. **é¸æ“‡æ‚¨çš„è§’è‰²ï¼ˆä¾‹å¦‚ 'staff'ï¼‰**
4. **å‹¾é¸éœ€è¦çš„æ¬Šé™ï¼š**

   **è»Šè¼›ç®¡ç†æ¬Šé™ï¼š**
   - âœ… `car.vehicle.create` - æ–°å¢è»Šè¼›
   - âœ… `car.vehicle.edit` - ç·¨è¼¯è»Šè¼›è³‡æ–™
   - âœ… `car.vehicle.delete` - åˆªé™¤è»Šè¼›

   **æœƒè­°å®¤ç®¡ç†æ¬Šé™ï¼š**
   - âœ… `meeting.room.create` - æ–°å¢æœƒè­°å®¤
   - âœ… `meeting.room.edit` - ç·¨è¼¯æœƒè­°å®¤
   - âœ… `meeting.room.delete` - åˆªé™¤æœƒè­°å®¤

5. **é»æ“Šã€Œä¿å­˜ã€**
6. **é‡æ–°æ•´ç†é é¢**

### æ–¹æ¡ˆ Cï¼šä¿®æ­£å“¡å·¥è§’è‰²

**é©ç”¨æƒ…æ³ï¼š**
- `employees.role` å€¼æ‹¼å¯«éŒ¯èª¤æˆ–ä½¿ç”¨äº†éæ¨™æº–å€¼
- è¨ºæ–·é¡¯ç¤ºã€Œè§’è‰²ç„¡æ³•æ˜ å°„ã€

**æ¨™æº–è§’è‰²åˆ—è¡¨ï¼š**
- `admin` - ç³»çµ±ç®¡ç†å“¡
- `hr` - äººè³‡
- `boss` - æ”¾è¡Œä¸»ç®¡
- `unit_manager` - å–®ä½ä¸»ç®¡
- `accountant` - æœƒè¨ˆ
- `audit_manager` - å¯©æ ¸ä¸»ç®¡
- `cashier` - å‡ºç´
- `manager` - ä¸»ç®¡
- `staff` - ä¸€èˆ¬å“¡å·¥
- `user` - ä¸€èˆ¬ä½¿ç”¨è€…

**æ“ä½œæ­¥é©Ÿï¼š**

1. **æª¢æŸ¥ç•¶å‰è§’è‰²ï¼š**
   ```sql
   SELECT name, employee_id, role
   FROM public.employees
   WHERE email = 'your@email.com';
   ```

2. **å¦‚æœè§’è‰²å€¼ä¸æ­£ç¢ºï¼Œä¿®æ­£å®ƒï¼š**
   ```sql
   UPDATE public.employees
   SET role = 'staff'  -- æˆ–å…¶ä»–æ¨™æº–è§’è‰²
   WHERE email = 'your@email.com';
   ```

3. **è§¸ç™¼å™¨æœƒè‡ªå‹•é‡æ–°åŒæ­¥è§’è‰²åˆ° RBAC**

---

## ğŸ“Š æ¬Šé™åˆ†é…åƒè€ƒ

### é è¨­æ¬Šé™åˆ†é…ç­–ç•¥

| è§’è‰² | è»Šè¼›ç®¡ç† | ç§Ÿè»Šç”³è«‹ | å¯©æ ¸ | æœƒè­°å®¤ç®¡ç† | æœƒè­°å®¤é ç´„ |
|-----|---------|---------|-----|-----------|-----------|
| **admin** | âœ… å®Œæ•´ | âœ… æ‰€æœ‰ | âœ… | âœ… å®Œæ•´ | âœ… æ‰€æœ‰ |
| **manager** | âœ… å®Œæ•´ | âœ… æ‰€æœ‰ | âœ… | âœ… å®Œæ•´ | âœ… æ‰€æœ‰ |
| **staff** | âŒ | âœ… è‡ªå·±çš„ | âŒ | âŒ | âœ… è‡ªå·±çš„ |
| **user** | âŒ | âŒ | âŒ | âŒ | âŒ |

**èªªæ˜ï¼š**
- **å®Œæ•´** = create, edit, delete, view
- **æ‰€æœ‰** = view.all, cancel.all
- **è‡ªå·±çš„** = view.own, edit.own, cancel.own

### çµ„ä»¶éœ€è¦çš„å…·é«”æ¬Šé™

#### è»Šè¼›ç³»çµ± (Vehicles.jsx)

```javascript
// æ–°å¢è»Šè¼›æŒ‰éˆ•é¡¯ç¤ºæ¢ä»¶
car.vehicle.create â†’ åªæœ‰ manager/admin é è¨­æ“æœ‰

// ç·¨è¼¯è»Šè¼›æŒ‰éˆ•é¡¯ç¤ºæ¢ä»¶
car.vehicle.edit â†’ åªæœ‰ manager/admin é è¨­æ“æœ‰

// åˆªé™¤è»Šè¼›æŒ‰éˆ•é¡¯ç¤ºæ¢ä»¶
car.vehicle.delete â†’ åªæœ‰ manager/admin é è¨­æ“æœ‰
```

**å¦‚æœæ‚¨éœ€è¦ staff ä¹Ÿèƒ½ç®¡ç†è»Šè¼›ï¼š**
â†’ åœ¨ Management Center ä¸­ï¼Œç‚º 'staff' è§’è‰²æ·»åŠ  `car.vehicle.*` æ¬Šé™

#### ç§Ÿè»Šç”³è«‹ (RentalRequests.jsx)

```javascript
// å»ºç«‹ç”³è«‹æŒ‰éˆ•
car.request.create â†’ staff, manager, admin éƒ½æœ‰

// å¯©æ ¸æŒ‰éˆ•
car.approve â†’ åªæœ‰ manager, admin æœ‰

// æŸ¥çœ‹æ‰€æœ‰ç”³è«‹
car.request.view.all â†’ åªæœ‰ manager, admin æœ‰
```

#### æœƒè­°å®¤ç³»çµ± (BookingForm.jsx, Dashboard.jsx)

```javascript
// å»ºç«‹é ç´„
meeting.booking.create â†’ staff, manager, admin éƒ½æœ‰

// ç·¨è¼¯è‡ªå·±çš„é ç´„
meeting.booking.edit.own â†’ staff, manager, admin éƒ½æœ‰

// å–æ¶ˆä»»ä½•äººçš„é ç´„
meeting.booking.cancel.all â†’ åªæœ‰ manager, admin æœ‰
```

---

## ğŸ¯ å¸¸è¦‹å•é¡Œè§£ç­”

### Q1ï¼šç‚ºä»€éº¼æˆ‘ç„¡æ³•æ–°å¢è»Šè¼›ï¼Ÿ

**Aï¼š** é è¨­æƒ…æ³ä¸‹ï¼Œåªæœ‰ 'manager' å’Œ 'admin' è§’è‰²æ‰æœ‰ `car.vehicle.create` æ¬Šé™ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**
- é¸é … 1ï¼šè«‹ç®¡ç†å“¡å°‡æ‚¨çš„è§’è‰²æ”¹ç‚º 'manager'
- é¸é … 2ï¼šè«‹ç®¡ç†å“¡åœ¨ Management Center ä¸­ç‚ºæ‚¨çš„è§’è‰²æ·»åŠ  `car.vehicle.create` æ¬Šé™
- é¸é … 3ï¼šå¦‚æœæ‚¨æœ‰ `rbac.manage` æ¬Šé™ï¼Œè‡ªå·±æ·»åŠ 

### Q2ï¼šç‚ºä»€éº¼æˆ‘ç„¡æ³•é ç´„æœƒè­°å®¤ï¼Ÿ

**Aï¼š** å¯èƒ½çš„åŸå› ï¼š
1. æ‚¨çš„å“¡å·¥è§’è‰²æ˜¯ 'user' è€Œä¸æ˜¯ 'staff' â†’ éœ€æ”¹ç‚º 'staff' æˆ–æ›´é«˜
2. è§’è‰²åŒæ­¥å¤±æ•— â†’ é‹è¡Œ `fix_role_sync_add_missing_roles.sql`
3. æ¬Šé™è¢«ç§»é™¤ â†’ åœ¨ Management Center é‡æ–°æ·»åŠ 

### Q3ï¼šæˆ‘åœ¨ Management Center ä¸­ä¿®æ”¹äº†æ¬Šé™ï¼Œä½†å‰ç«¯é‚„æ˜¯è¢«é˜»æ“‹ï¼Ÿ

**Aï¼š** å¯èƒ½çš„åŸå› ï¼š
1. **ç€è¦½å™¨å¿«å–** â†’ é‡æ–°æ•´ç†é é¢ï¼ˆCtrl+F5ï¼‰
2. **éœ€è¦é‡æ–°ç™»å…¥** â†’ ç™»å‡ºå¾Œé‡æ–°ç™»å…¥
3. **RLS ç­–ç•¥å•é¡Œ** â†’ æª¢æŸ¥ `fix_rbac_rls_policies.sql` æ˜¯å¦å·²åŸ·è¡Œ

### Q4ï¼šå¦‚ä½•æŸ¥çœ‹æˆ‘ç›®å‰æ“æœ‰å“ªäº›æ¬Šé™ï¼Ÿ

**Aï¼š** å…©ç¨®æ–¹æ³•ï¼š
1. **é€é Management Centerï¼š**
   - ç™»å…¥ â†’ æ¬Šé™ç®¡ç† â†’ è§’è‰²ç®¡ç† â†’ é¸æ“‡æ‚¨çš„è§’è‰²

2. **é€é SQL æŸ¥è©¢ï¼š**
   ```sql
   SELECT DISTINCT p.code, p.name, p.module
   FROM rbac.user_roles ur
   JOIN rbac.role_permissions rp ON ur.role_id = rp.role_id
   JOIN rbac.permissions p ON rp.permission_id = p.id
   JOIN auth.users u ON ur.user_id = u.id
   WHERE u.email = 'your@email.com'
     AND p.deleted_at IS NULL
   ORDER BY p.module, p.code;
   ```

### Q5ï¼šManagement Center é¡¯ç¤ºã€Œç„¡ç®¡ç†æ¬Šé™ã€æ€éº¼è¾¦ï¼Ÿ

**Aï¼š** æ‚¨éœ€è¦ `rbac.manage` æ¬Šé™æ‰èƒ½ä½¿ç”¨ Management Center çš„æ¬Šé™ç®¡ç†åŠŸèƒ½ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. è¯çµ¡ç³»çµ±ç®¡ç†å“¡
2. è«‹ç®¡ç†å“¡ç‚ºæ‚¨çš„è§’è‰²æ·»åŠ  `rbac.manage` æ¬Šé™
3. æˆ–å°‡æ‚¨çš„è§’è‰²æ”¹ç‚º 'admin'

---

## ğŸ”§ èª¿è©¦å·¥å…·

### æ¸¬è©¦æ¬Šé™æª¢æŸ¥å‡½æ•¸

```sql
-- æ¸¬è©¦ç”¨æˆ¶æ˜¯å¦æœ‰ç‰¹å®šæ¬Šé™
SELECT rbac.user_has_permission(
  (SELECT id FROM auth.users WHERE email = 'your@email.com'),
  'car.vehicle.create'
) as has_permission;
```

### æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æ¬Šé™

```sql
SELECT code, name, module, category
FROM rbac.permissions
WHERE deleted_at IS NULL
  AND module IN ('car_rental', 'meeting_room')
ORDER BY module, code;
```

### æŸ¥çœ‹è§’è‰²çš„æ¬Šé™åˆ†é…

```sql
SELECT
  r.name as role_name,
  p.code as permission_code,
  p.name as permission_name,
  p.module
FROM rbac.roles r
JOIN rbac.role_permissions rp ON r.id = rp.role_id
JOIN rbac.permissions p ON rp.permission_id = p.id
WHERE r.code = 'staff'  -- æ›¿æ›ç‚ºæ‚¨çš„è§’è‰²
  AND p.deleted_at IS NULL
  AND rp.deleted_at IS NULL
ORDER BY p.module, p.code;
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- **æ¬Šé™å•é¡Œå®Œæ•´åˆ†æï¼š** `/docs/PERMISS ION_MISMATCH_ANALYSIS.md`
- **è§’è‰²åŒæ­¥ä¿®å¾©æ–‡æª”ï¼š** `/docs/RBAC_ROLE_SYNC_FIX.md`
- **RBAC æ•´åˆæŒ‡å—ï¼š** `/docs/RBAC_INTEGRATION_GUIDE.md`
- **RBAC ä½¿ç”¨ç¯„ä¾‹ï¼š** `/docs/RBAC_EXAMPLES.md`

---

## âœ… æª¢æŸ¥æ¸…å–®

åŸ·è¡Œä¿®å¾©å¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹äº‹é …ï¼š

- [ ] å“¡å·¥è¨˜éŒ„å­˜åœ¨ä¸” `role` æ¬„ä½æ­£ç¢º
- [ ] `rbac.user_roles` è¡¨ä¸­æœ‰å°æ‡‰çš„è§’è‰²åˆ†é…
- [ ] åœ¨ Management Center ä¸­å¯ä»¥çœ‹åˆ°æ‚¨çš„è§’è‰²å’Œæ¬Šé™
- [ ] é‹è¡Œè¨ºæ–·è…³æœ¬é¡¯ç¤ºæ‰€æœ‰æ¬Šé™æª¢æŸ¥ç‚º âœ…
- [ ] å‰ç«¯åŠŸèƒ½æŒ‰éˆ•æ­£å¸¸é¡¯ç¤ºï¼ˆä¸å†è¢«éš±è—ï¼‰
- [ ] å¯¦éš›æ“ä½œåŠŸèƒ½æ™‚ä¸æœƒè¢«é˜»æ“‹

---

## ğŸ†˜ ä»ç„¶æœ‰å•é¡Œï¼Ÿ

å¦‚æœåŸ·è¡Œäº†æ‰€æœ‰æ­¥é©Ÿä»ç„¶ç„¡æ³•è§£æ±ºï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

1. **è¨ºæ–·è…³æœ¬çš„å®Œæ•´è¼¸å‡º**
2. **æ‚¨çš„è§’è‰²ï¼š** `employees.role` çš„å€¼
3. **è¢«é˜»æ“‹çš„å…·é«”åŠŸèƒ½ï¼š** ä¾‹å¦‚ã€Œç„¡æ³•æ–°å¢è»Šè¼›ã€
4. **éŒ¯èª¤è¨Šæ¯æˆ–è¡Œç‚ºï¼š** æŒ‰éˆ•æ¶ˆå¤±ï¼Ÿé»æ“Šå¾Œå ±éŒ¯ï¼Ÿ
5. **ç€è¦½å™¨æ§åˆ¶å°çš„éŒ¯èª¤è¨Šæ¯**

å°‡é€™äº›è³‡è¨Šæä¾›çµ¦æŠ€è¡“æ”¯æ´åœ˜éšŠä»¥ç²å¾—é€²ä¸€æ­¥å”åŠ©ã€‚
